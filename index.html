<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>학교 & 학급 건의함</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2ff;
        }
        .container-card {
            max-width: 800px;
            min-height: 80vh;
        }
        .suggestion-list::-webkit-scrollbar {
            width: 8px;
        }
        .suggestion-list::-webkit-scrollbar-thumb {
            background-color: #93c5fd;
            border-radius: 10px;
        }
        .suggestion-list::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .btn-focus:focus {
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.5);
            outline: none;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex flex-col items-center justify-start">

    <div class="container-card w-full bg-white rounded-2xl shadow-2xl p-6 sm:p-10 my-8">
        <h1 class="text-4xl font-extrabold text-center text-indigo-800 mb-8 border-b-4 border-indigo-200 pb-4">
            학교 & 학급 건의함
        </h1>

        <div id="user-info" class="text-sm text-gray-700 mb-6 p-4 bg-indigo-50 border-l-4 border-indigo-400 rounded-lg shadow-inner">
            <p><span class="font-bold">사용자 ID:</span> <span id="current-user-id" class="font-mono text-xs break-all">인증 중...</span></p>
        </div>

        <div class="flex mb-6 bg-gray-100 p-1 rounded-xl shadow-md">
            <button id="tab-school" data-scope="school"
                    class="flex-1 py-3 text-center text-lg font-semibold rounded-lg transition duration-300 btn-focus
                           bg-indigo-600 text-white shadow-lg">
                학교 건의함
            </button>
            <button id="tab-class" data-scope="class"
                    class="flex-1 py-3 text-center text-lg font-semibold rounded-lg transition duration-300 btn-focus
                           text-gray-700 hover:bg-white/50">
                학급 건의함
            </button>
        </div>

        <div id="admin-view-controls" class="mb-8 p-5 border border-gray-300 rounded-xl bg-gray-50 shadow-inner">
            <h2 class="text-xl font-bold text-gray-700 mb-3">전체 목록 보기 (관리자 모드)</h2>
            <div id="password-input-area" class="flex flex-col sm:flex-row sm:space-x-3 space-y-3 sm:space-y-0">
                <input type="password" id="admin-password" placeholder="비밀번호 입력"
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition duration-150">
                <button type="button" id="admin-login-button"
                        class="px-6 py-3 bg-gray-700 text-white font-bold rounded-lg hover:bg-gray-800 transition duration-300 shadow-md btn-focus">
                    확인
                </button>
            </div>
            <div id="admin-view-status" class="mt-3 text-sm font-medium">
                <p id="view-mode-text" class="text-red-500">현재: 내가 쓴 글만 보기</p>
            </div>
        </div>

        <form id="suggestion-form" class="mb-10 p-6 border border-indigo-300 rounded-2xl bg-indigo-50 shadow-lg">
            <h2 class="text-2xl font-bold text-indigo-700 mb-4">새로운 건의사항 제출</h2>
            <input type="text" id="suggestion-title" placeholder="제목을 입력하세요 (예: 급식 잔반 문제 개선)" required
                   class="w-full p-3 mb-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-600 focus:border-indigo-600 transition duration-150">
            <textarea id="suggestion-content" rows="5" placeholder="내용을 자세하고 정중하게 적어주세요." required
                      class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-600 focus:border-indigo-600 transition duration-150"></textarea>
            <button type="submit" id="submit-button"
                    class="w-full py-3 bg-indigo-600 text-white font-bold text-lg rounded-lg hover:bg-indigo-700 transition duration-300 shadow-xl disabled:bg-indigo-400 btn-focus">
                건의하기
            </button>
            <p id="form-message" class="text-center text-sm mt-3 hidden"></p>
        </form>

        <div>
            <h2 id="list-title" class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">학교 건의사항 목록</h2>
            <div id="suggestions-list" class="suggestion-list space-y-4 max-h-[60vh] overflow-y-auto pr-3">
                <p id="loading-message" class="text-center text-gray-500 p-8">데이터를 불러오는 중...</p>
            </div>
            <p id="no-suggestions" class="text-center text-gray-500 mt-6 p-4 hidden border rounded-lg bg-white shadow-sm">아직 등록된 건의사항이 없습니다.</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp, setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 관리자 비밀번호 (개발/테스트용). 배포 시 안전한 방식으로 대체
        const ADMIN_PASSWORD = '202517';

        // TODO: 실제 Firebase 설정 입력
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const appId = 'school-suggestion-box-web';

        let db;
        let auth;
        let currentUserId = null;
        let currentScope = 'school';
        let isAuthReady = false;
        let viewAllMode = false;
        let unsubscribe = null;

        // UI 엘리먼트 캐싱
        const listTitleEl = document.getElementById('list-title');
        const suggestionsListEl = document.getElementById('suggestions-list');
        const loadingMessageEl = document.getElementById('loading-message');
        const noSuggestionsEl = document.getElementById('no-suggestions');
        const userIdEl = document.getElementById('current-user-id');
        const formMessageEl = document.getElementById('form-message');
        const submitButton = document.getElementById('submit-button');
        const adminPasswordEl = document.getElementById('admin-password');
        const adminLoginButton = document.getElementById('admin-login-button');
        const viewModeTextEl = document.getElementById('view-mode-text');

        // Firebase 초기화
        async function initializeFirebase() {
            try {
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes('YOUR_API_KEY')) {
                    console.warn("경고: Firebase 설정값이 플레이스홀더입니다. 실제 값으로 교체하세요.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Firestore 로그 레벨 설정
                setLogLevel('error');

                // 익명 로그인 시도
                await signInAnonymously(auth);

                // 인증 상태 리스너
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdEl.textContent = currentUserId;
                        isAuthReady = true;
                        startRealtimeListener(currentScope);
                    } else {
                        userIdEl.textContent = '인증 실패';
                        isAuthReady = true;
                        loadingMessageEl.classList.add('hidden');
                    }
                });
            } catch (error) {
                console.error("Firebase 초기화 또는 인증 오류:", error);
                userIdEl.textContent = '오류 발생 (콘솔 확인)';
                loadingMessageEl.textContent = '서비스 초기화에 실패했습니다.';
            }
        }

        // 실시간 리스너 시작
        function startRealtimeListener(scope) {
            if (unsubscribe) {
                try { unsubscribe(); } catch (e) { /* ignore */ }
                unsubscribe = null;
            }

            if (!db || !isAuthReady || !currentUserId) {
                return;
            }

            const collectionPath = `/artifacts/${appId}/public/data/suggestions`;
            const suggestionsCol = collection(db, collectionPath);

            const queryArgs = [suggestionsCol, where('scope', '==', scope)];
            if (!viewAllMode) {
                queryArgs.push(where('userId', '==', currentUserId));
            }

            const q = query(...queryArgs);

            suggestionsListEl.innerHTML = '';
            loadingMessageEl.classList.remove('hidden');
            noSuggestionsEl.classList.add('hidden');

            unsubscribe = onSnapshot(q, (snapshot) => {
                loadingMessageEl.classList.add('hidden');

                const suggestions = [];
                snapshot.forEach(doc => {
                    suggestions.push({ id: doc.id, ...doc.data() });
                });

                // 서버 타임스탬프 정렬이 불확실할 때를 대비해 클라이언트에서 정렬
                suggestions.sort((a, b) => (b.timestamp?.toMillis?.() || 0) - (a.timestamp?.toMillis?.() || 0));

                renderSuggestions(suggestions);
            }, (error) => {
                console.error("실시간 데이터 로딩 오류:", error);
                loadingMessageEl.textContent = '데이터 로딩 중 오류 발생. (콘솔 확인)';
                if (unsubscribe) {
                    try { unsubscribe(); } catch (e) { /* ignore */ }
                    unsubscribe = null;
                }
            });
        }

        // 타임스탬프 포맷
        function formatTimestamp(timestamp) {
            if (!timestamp) return '시간 정보 없음';
            const date = typeof timestamp.toDate === 'function' ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString('ko-KR', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });
        }

        // View 모드 UI 업데이트
        function updateViewModeUI() {
            if (viewAllMode) {
                viewModeTextEl.textContent = '현재: 모든 건의사항 보기 (관리자 모드)';
                viewModeTextEl.className = 'text-green-600 mt-2 text-sm font-bold';
                adminLoginButton.textContent = '로그아웃';
                adminPasswordEl.classList.add('hidden');
                adminPasswordEl.value = '';
            } else {
                viewModeTextEl.textContent = '현재: 내가 쓴 글만 보기';
                viewModeTextEl.className = 'text-red-500 mt-2 text-sm font-bold';
                adminLoginButton.textContent = '확인';
                adminPasswordEl.classList.remove('hidden');
            }

            const scopeText = currentScope === 'school' ? '학교' : '학급';
            listTitleEl.textContent = `${scopeText} 건의사항 목록${viewAllMode ? ' (전체 보기)' : ' (내 글만 보기)'}`;
        }

        // 렌더링
        function renderSuggestions(suggestions) {
            suggestionsListEl.innerHTML = '';

            if (suggestions.length === 0) {
                noSuggestionsEl.classList.remove('hidden');
                return;
            } else {
                noSuggestionsEl.classList.add('hidden');
            }

            suggestions.forEach(suggestion => {
                const isMine = suggestion.userId === currentUserId;
                const formattedDate = formatTimestamp(suggestion.timestamp);

                const suggestionEl = document.createElement('div');
                suggestionEl.className = `p-5 border-l-4 rounded-xl shadow-lg transition duration-200 hover:shadow-xl ${isMine ? 'border-green-500 bg-green-50' : 'border-indigo-500 bg-white hover:bg-gray-50'}`;

                suggestionEl.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-xl font-bold text-gray-900 break-words">${escapeHtml(suggestion.title)}</h3>
                        <span class="text-xs font-semibold ${isMine ? 'text-green-700 bg-green-200' : 'text-indigo-700 bg-indigo-200'} px-3 py-1 rounded-full">
                            ${isMine ? '내가 쓴 글' : '건의사항'}
                        </span>
                    </div>
                    <p class="text-base text-gray-700 mb-4 whitespace-pre-wrap leading-relaxed">${escapeHtml(suggestion.content)}</p>
                    <div class="text-xs text-gray-500 border-t border-gray-200 pt-3 mt-3">
                        <p>작성자 ID: <span class="font-mono text-gray-700 font-semibold">${viewAllMode ? suggestion.userId : (suggestion.userId ? suggestion.userId.substring(0,8) + '...' : '익명')}</span></p>
                        <p>작성일: ${formattedDate}</p>
                    </div>
                `;
                suggestionsListEl.appendChild(suggestionEl);
            });
        }

        // 간단한 HTML 이스케이프
        function escapeHtml(text) {
            if (!text && text !== 0) return '';
            return String(text)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        // 관리자 로그인/로그아웃 처리
        async function handleAdminLogin(e) {
            if (e) e.preventDefault();

            if (viewAllMode) {
                viewAllMode = false;
                updateViewModeUI();
                startRealtimeListener(currentScope);
                displayMessage('관리자 모드에서 로그아웃했습니다.', 'text-gray-600');
                return;
            }

            const password = adminPasswordEl.value.trim();
            if (password === ADMIN_PASSWORD) {
                viewAllMode = true;
                updateViewModeUI();
                startRealtimeListener(currentScope);
                displayMessage('관리자 모드 활성화: 모든 글 보기', 'text-green-600');
            } else {
                displayMessage('비밀번호가 일치하지 않습니다.', 'text-red-500');
                adminPasswordEl.value = '';
                adminPasswordEl.focus();
            }
        }

        // 제출 처리
        async function handleSubmit(event) {
            event.preventDefault();

            if (!isAuthReady || !currentUserId || !db) {
                displayMessage('인증 대기 중이니 잠시 후 시도해 봐', 'text-red-500');
                return;
            }

            const titleEl = document.getElementById('suggestion-title');
            const contentEl = document.getElementById('suggestion-content');
            const title = titleEl.value.trim();
            const content = contentEl.value.trim();

            if (!title || !content) {
                displayMessage('제목과 내용을 모두 입력해 줘', 'text-red-500');
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = '제출 중...';
            displayMessage('서버에 건의사항을 제출하는 중', 'text-indigo-500');

            try {
                const collectionPath = `/artifacts/${appId}/public/data/suggestions`;
                await addDoc(collection(db, collectionPath), {
                    title: title,
                    content: content,
                    scope: currentScope,
                    userId: currentUserId,
                    timestamp: serverTimestamp()
                });

                titleEl.value = '';
                contentEl.value = '';
                displayMessage('건의사항이 성공적으로 제출됐어', 'text-green-600');

                // 자동으로 '내 글만 보기' 상태에서 본인 글이 보이도록 리스너 재시작
                if (!viewAllMode) startRealtimeListener(currentScope);
            } catch (error) {
                console.error("건의사항 제출 오류:", error);
                let errorMessage = '제출 중 알 수 없는 오류가 발생했어';
                if (error && error.message && error.message.includes('permission denied')) {
                    errorMessage = '제출 권한이 없어. Firebase 보안 규칙을 확인해줘';
                } else if (error && error.message) {
                    errorMessage = `제출 오류: ${error.message.split('\n')[0]}`;
                }
                displayMessage(errorMessage, 'text-red-600');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = '건의하기';
            }
        }

        // 메시지 표시
        function displayMessage(message, className) {
            formMessageEl.textContent = message;
            formMessageEl.className = `text-center text-base mt-4 font-semibold ${className}`;
            formMessageEl.classList.remove('hidden');

            setTimeout(() => {
                formMessageEl.classList.add('hidden');
            }, 5000);
        }

        // 탭 전환
        function switchScope(newScope) {
            if (currentScope === newScope) return;

            currentScope = newScope;

            document.querySelectorAll('[data-scope]').forEach(btn => {
                const isSelected = btn.dataset.scope === newScope;
                btn.classList.toggle('bg-indigo-600', isSelected);
                btn.classList.toggle('text-white', isSelected);
                btn.classList.toggle('shadow-lg', isSelected);
                btn.classList.toggle('text-gray-700', !isSelected);
                btn.classList.toggle('hover:bg-white/50', !isSelected);
            });

            updateViewModeUI();

            if (isAuthReady) {
                startRealtimeListener(currentScope);
            }
        }

        // 초기화 및 이벤트 바인딩
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('suggestion-form').addEventListener('submit', handleSubmit);
            document.getElementById('tab-school').addEventListener('click', () => switchScope('school'));
            document.getElementById('tab-class').addEventListener('click', () => switchScope('class'));

            adminLoginButton.addEventListener('click', handleAdminLogin);
            adminPasswordEl.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleAdminLogin(e);
                }
            });

            // Firebase 초기화 실행
            initializeFirebase();
        });
    </script>
</body>
</html>
